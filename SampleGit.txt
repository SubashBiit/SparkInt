PREPAID_RECHARGE_FACT^SUBSCRIBER_KEY,BUSINESS_DATE^SELECT  SUBSCRIBER_KEY, '2018-08-31' AS BUSINESS_DATE, TOP_DENOM AS CHURNER_TOPUP_DENOMINATION_FREQUENT_6_MONTHS FROM ( SELECT *, ROW_NUMBER() OVER(PARTITION BY SUBSCRIBER_KEY ORDER BY COUNT DESC) AS RN FROM (SELECT A.SUBSCRIBER_KEY, CASE WHEN AMOUNT IN (2.83,3,3.18) THEN 3 WHEN AMOUNT IN (4.71,4.72,5,5.3) THEN 5 WHEN AMOUNT IN (9.43,10,10.6) THEN 10 WHEN AMOUNT IN (18.86,18.87,20,21.2) THEN 20 WHEN AMOUNT IN (28.3,30,31.8) THEN 30 WHEN AMOUNT IN (47.16,47.17,50,53) THEN 50 WHEN AMOUNT IN (56.6,60,63.6) THEN 60 WHEN AMOUNT IN (94.33,94.34,100,105,106) THEN 100 ELSE AMOUNT END AS TOP_DENOM, COUNT(*) AS COUNT FROM BDVTDM_b2.PREPAID_RECHARGE_FACT A  INNER JOIN BDVTDM_b2.SUBSCRIBER_DIMENSION B ON A.SUBSCRIBER_KEY = B.SUBSCRIBER_KEY INNER JOIN BDVTDM_b2.DATE_DIMENSION C ON A.RECHARGE_DATE_KEY = C.DATE_KEY WHERE NVL(A.RECHARGE_TYPE,'') NOT IN ('SHARE A TOPUP','ASK A TOPUP') AND B.SUBSCRIPTION_CATEGORY = 'PREPAID' AND B.ROW_GRANULARITY = 'SUBSCRIBER' AND B.SOURCE_ID = 'AMDOCS' AND B.SUBSCRIBER_STATUS = 'CLOSE' AND MONTH(C.DATE_VAL) <= MONTH(ADD_MONTHS(B.SUBSCRIBER_STATUS_CHANGE_DATE,-1))  AND MONTH(C.DATE_VAL) >= MONTH(ADD_MONTHS(B.SUBSCRIBER_STATUS_CHANGE_DATE,-6)) AND MONTH(B.SUBSCRIBER_STATUS_CHANGE_DATE) = '8' GROUP BY 1,2 ORDER BY 1,2 ) A  ) A WHERE RN = 1 AND TOP_DENOM > 0 ORDER BY 1^PREPAID_SUBSCRIBER_RECHARGE_MONTHLY^SELECT SUBSCRIBER_KEY, BUSINESS_DATE CHURNER_TOPUP_DENOMINATION_FREQUENT_6_MONTHS FROM BDVMART_b2.PREPAID_SUBSCRIBER_RECHARGE_MONTHLY_MOCK WHERE CHURNER_TOPUP_DENOMINATION_FREQUENT_6_MONTHS > 0 ORDER BY 1^SUBSCRIBER_KEY:NUMBER:9,BUSINESS_DATE:DATE,CHURNER_TOPUP_DENOMINATION_FREQUENT_6_MONTHS:NUMBER:39
